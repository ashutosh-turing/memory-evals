<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory-Break Orchestrator</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f4ff',
                            100: '#e5edff',
                            200: '#d1deff',
                            300: '#b3c5ff',
                            400: '#85a3ff',
                            500: '#667eea',
                            600: '#5a67d8',
                            700: '#4c51bf',
                            800: '#434190',
                            900: '#3c366b',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-primary-500 to-purple-600 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-xl overflow-hidden mb-8">
            <div class="bg-gradient-to-r from-primary-500 to-purple-600 text-white p-8 text-center">
                <h1 class="text-4xl font-light mb-3">Memory-Break Orchestrator</h1>
                <p class="text-primary-100 text-lg">Evaluate AI agent memory compression across iFlow, Claude, and Gemini</p>
            </div>
            
            <div class="p-8">
                <!-- System Health -->
                <div v-if="systemHealth" class="flex items-center gap-3 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="w-3 h-3 rounded-full" :class="{
                        'bg-green-500': systemHealth.status === 'healthy',
                        'bg-yellow-500': systemHealth.status === 'degraded', 
                        'bg-red-500': systemHealth.status === 'unhealthy'
                    }"></div>
                    <span class="font-semibold text-gray-800">System Status:</span>
                    <span class="text-gray-700 uppercase font-medium">{{ systemHealth.status }}</span>
                    <span v-if="systemHealth.agents" class="text-gray-600">
                        | <span class="font-medium">Agents:</span> {{ systemHealth.agents.available }}/{{ systemHealth.agents.total }} available
                    </span>
                </div>
                
                <!-- Error/Success Messages -->
                <div v-if="error" class="bg-red-50 border-l-4 border-red-400 text-red-700 p-4 mb-6 rounded">
                    {{ error }}
                </div>
                <div v-if="success" class="bg-green-50 border-l-4 border-green-400 text-green-700 p-4 mb-6 rounded">
                    {{ success }}
                </div>
                
                <!-- Create Task Form -->
                <div class="bg-gray-50 rounded-xl p-6 mb-8">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">Create New Memory-Break Task</h2>
                    <form @submit.prevent="createTask" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">GitHub PR URL</label>
                            <input 
                                v-model="newTask.pr_url" 
                                type="url" 
                                placeholder="https://github.com/owner/repo/pull/123"
                                required
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors"
                            >
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-3">Select Agents</label>
                            <div class="flex flex-wrap gap-4">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" value="iflow" v-model="newTask.agents" 
                                           class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500">
                                    <span class="text-sm font-medium text-gray-700">iFlow</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" value="claude" v-model="newTask.agents"
                                           class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500">
                                    <span class="text-sm font-medium text-gray-700">Claude</span>
                                </label>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" value="gemini" v-model="newTask.agents"
                                           class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500">
                                    <span class="text-sm font-medium text-gray-700">Gemini</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Max Files</label>
                            <input v-model="newTask.max_files" type="number" min="1" max="100" value="50"
                                   class="w-24 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors">
                        </div>
                        
                        <button type="submit" :disabled="creating" 
                                class="bg-gradient-to-r from-primary-500 to-purple-600 text-white px-6 py-3 rounded-lg font-medium hover:from-primary-600 hover:to-purple-700 transition-all transform hover:-translate-y-1 hover:shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none disabled:hover:shadow-none flex items-center space-x-2">
                            <svg v-if="creating" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>{{ creating ? 'Creating...' : 'Create Task' }}</span>
                        </button>
                    </form>
                </div>
                
                <!-- Tasks List -->
                <div class="space-y-6">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-semibold text-gray-800">Tasks</h2>
                        <button @click="refreshTasks" 
                                class="bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-700 transition-colors flex items-center space-x-2">
                            <svg v-if="loading" class="animate-spin h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <span>Refresh</span>
                        </button>
                    </div>
                    
                    <div v-if="tasks.length === 0" class="text-center py-12 text-gray-500">
                        <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p class="text-lg">No tasks yet. Create your first task above!</p>
                    </div>
                    
                    <!-- Task Cards -->
                    <div v-for="task in tasks" :key="task.id" class="bg-white rounded-xl shadow-md hover:shadow-lg transition-shadow border border-gray-200">
                        <!-- Task Header (Clickable) -->
                        <div @click="toggleTaskExpansion(task.id)" 
                             class="px-6 py-4 border-b border-gray-200 flex flex-wrap items-center justify-between gap-2 cursor-pointer hover:bg-gray-50 transition-colors">
                            <div class="flex items-center space-x-3">
                                <span class="font-mono text-sm bg-gray-100 px-3 py-1 rounded-full">{{ task.id.substring(0, 8) }}...</span>
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium uppercase tracking-wide" :class="{
                                    'bg-yellow-100 text-yellow-800': task.status === 'queued',
                                    'bg-blue-100 text-blue-800': task.status === 'running',
                                    'bg-purple-100 text-purple-800': task.status === 'judging',
                                    'bg-green-100 text-green-800': task.status === 'done',
                                    'bg-red-100 text-red-800': task.status === 'error'
                                }">
                                    {{ task.status }}
                                </span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600">{{ task.repo }} #{{ task.pr_number }}</span>
                                <svg :class="{'rotate-180': expandedTasks.has(task.id)}" 
                                     class="w-4 h-4 text-gray-400 transition-transform duration-200" 
                                     fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </div>
                        </div>
                        
                        <!-- Task Info (Expandable) -->
                        <div v-if="expandedTasks.has(task.id)" class="px-6 py-4 border-t border-gray-100">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                <div>
                                    <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Repository</div>
                                    <a :href="task.pr_url" target="_blank" 
                                       class="text-primary-600 hover:text-primary-800 font-medium font-mono text-sm transition-colors">
                                        {{ task.repo }} #{{ task.pr_number }}
                                    </a>
                                </div>
                                <div>
                                    <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Agents</div>
                                    <div class="text-sm font-medium text-gray-900">{{ task.agents.join(', ') }}</div>
                                </div>
                                <div>
                                    <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Created</div>
                                    <div class="text-sm text-gray-900">{{ formatDate(task.created_at) }}</div>
                                </div>
                                <div v-if="task.changed_files.length > 0">
                                    <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Changed Files</div>
                                    <div class="text-sm text-gray-900">{{ task.changed_files.length }} files</div>
                                </div>
                            </div>
                            
                            <!-- Task Actions -->
                            <div class="flex flex-wrap gap-2">
                                <!-- Show restart only for errored tasks -->
                                <button v-if="task.status === 'error'" @click="runTask(task.id)" 
                                        class="bg-yellow-600 text-white px-3 py-1 rounded-lg text-sm font-medium hover:bg-yellow-700 transition-colors">
                                    Restart Task
                                </button>
                                
                                <button @click="downloadBundle(task.id)" :disabled="task.status === 'queued' || task.status === 'running'"
                                        class="bg-primary-600 text-white px-3 py-1 rounded-lg text-sm font-medium hover:bg-primary-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    Download Bundle
                                </button>
                                
                                <button @click="viewArtifacts(task.id)" :disabled="task.status === 'queued' || task.status === 'running'"
                                        class="bg-gray-600 text-white px-3 py-1 rounded-lg text-sm font-medium hover:bg-gray-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                    View Artifacts
                                </button>
                                
                                <button @click="viewLiveLogs(task.id)" 
                                        class="bg-indigo-600 text-white px-3 py-1 rounded-lg text-sm font-medium hover:bg-indigo-700 transition-colors">
                                    📊 Live Logs
                                </button>
                                
                                <button v-if="task.status === 'running' || task.status === 'judging'" @click="cancelTask(task.id)"
                                        class="bg-red-600 text-white px-3 py-1 rounded-lg text-sm font-medium hover:bg-red-700 transition-colors">
                                    Cancel
                                </button>
                                
                                <!-- Show processing status for running tasks -->
                                <div v-if="task.status === 'running'" class="flex items-center space-x-2 px-3 py-1 bg-blue-100 text-blue-800 rounded-lg">
                                    <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    <span class="text-sm font-medium">Processing...</span>
                                </div>
                            </div>
                            
                            <!-- Leaderboard -->
                            <div v-if="taskLeaderboards[task.id] && taskLeaderboards[task.id].length > 0" class="mt-6">
                                <h4 class="text-sm font-medium text-gray-700 uppercase tracking-wide mb-3">🏆 Leaderboard</h4>
                                <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rank</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Agent</th>
                                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Overall</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">AR</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">TTL</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">LRU</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">SF</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Compressed</th>
                                            </tr>
                                        </thead>
                                        <tbody class="bg-white divide-y divide-gray-200">
                                            <tr v-for="(entry, index) in taskLeaderboards[task.id]" :key="entry.agent" 
                                                :class="{'bg-yellow-50': index === 0}">
                                                <td class="px-4 py-3 whitespace-nowrap">
                                                    <span v-if="index === 0" class="text-2xl">🥇</span>
                                                    <span v-else-if="index === 1" class="text-2xl">🥈</span>
                                                    <span v-else-if="index === 2" class="text-2xl">🥉</span>
                                                    <span v-else class="text-sm text-gray-500">{{ index + 1 }}</span>
                                                </td>
                                                <td class="px-4 py-3 whitespace-nowrap">
                                                    <span class="font-semibold text-gray-800 uppercase">{{ entry.agent }}</span>
                                                </td>
                                                <td class="px-4 py-3 whitespace-nowrap">
                                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium" :class="{
                                                        'bg-green-100 text-green-800': entry.status === 'done',
                                                        'bg-red-100 text-red-800': entry.status === 'error',
                                                        'bg-blue-100 text-blue-800': entry.status === 'running'
                                                    }">
                                                        {{ entry.status }}
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 text-center">
                                                    <span class="font-bold" :class="{
                                                        'text-green-600': entry.overall_score >= 0.7,
                                                        'text-yellow-600': entry.overall_score >= 0.5 && entry.overall_score < 0.7,
                                                        'text-red-600': entry.overall_score < 0.5
                                                    }">
                                                        {{ (entry.overall_score * 100).toFixed(1) }}%
                                                    </span>
                                                </td>
                                                <td class="px-4 py-3 text-center text-sm">{{ (entry.scores.AR * 100).toFixed(0) }}%</td>
                                                <td class="px-4 py-3 text-center text-sm">{{ (entry.scores.TTL * 100).toFixed(0) }}%</td>
                                                <td class="px-4 py-3 text-center text-sm">{{ (entry.scores.LRU * 100).toFixed(0) }}%</td>
                                                <td class="px-4 py-3 text-center text-sm">{{ (entry.scores.SF * 100).toFixed(0) }}%</td>
                                                <td class="px-4 py-3 text-center text-sm text-gray-600">{{ entry.execution_time.toFixed(1) }}s</td>
                                                <td class="px-4 py-3 text-center">
                                                    <span v-if="entry.compression_detected" class="text-green-600">✓</span>
                                                    <span v-else class="text-gray-400">✗</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Agent Results -->
                            <div v-if="taskAgents[task.id]" class="mt-6 space-y-3">
                                <h4 class="text-sm font-medium text-gray-700 uppercase tracking-wide">Agent Results</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div v-for="agent in taskAgents[task.id]" :key="agent.id" 
                                         class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <h5 class="font-semibold text-gray-800 uppercase">{{ agent.agent }}</h5>
                                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium" :class="{
                                                'bg-yellow-100 text-yellow-800': agent.status === 'queued',
                                                'bg-blue-100 text-blue-800': agent.status === 'running',
                                                'bg-purple-100 text-purple-800': agent.status === 'memory_only',
                                                'bg-indigo-100 text-indigo-800': agent.status === 'evaluating',
                                                'bg-green-100 text-green-800': agent.status === 'done',
                                                'bg-red-100 text-red-800': agent.status === 'error'
                                            }">
                                                {{ agent.status }}
                                            </span>
                                        </div>
                                        
                                        <div v-if="agent.stats && Object.keys(agent.stats).length > 0" class="mb-3">
                                            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Stats</div>
                                            <div class="text-xs space-y-1">
                                                <div v-for="(value, key) in agent.stats" :key="key" class="flex justify-between">
                                                    <span class="font-medium">{{ key }}:</span>
                                                    <span>{{ value }}</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div v-if="agent.artifacts && Object.keys(agent.artifacts).length > 0">
                                            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-2">Artifacts</div>
                                            <div class="flex flex-wrap gap-1">
                                                <a v-for="(path, name) in agent.artifacts" :key="name"
                                                   :href="`/api/v1/artifacts/${task.id}/${agent.agent}/${name}`"
                                                   target="_blank"
                                                   class="bg-primary-600 text-white px-2 py-1 rounded text-xs font-medium hover:bg-primary-700 transition-colors">
                                                    {{ name }}
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        
        createApp({
            data() {
                return {
                    tasks: [],
                    taskAgents: {},
                    taskLeaderboards: {},
                    systemHealth: null,
                    expandedTasks: new Set(), // Track which tasks are expanded
                    loadingAgents: new Set(), // Track which agent details are loading
                    apiCache: new Map(), // Cache API responses
                    cacheTimeout: 30000, // 30 seconds cache timeout
                    lastRefresh: 0,
                    refreshCooldown: 2000, // 2 seconds between refreshes
                    retryCount: 0,
                    maxRetries: 3,
                    newTask: {
                        pr_url: '',
                        agents: ['iflow'],
                        max_files: 50
                    },
                    loading: false,
                    creating: false,
                    error: null,
                    success: null
                }
            },
            
            mounted() {
                this.loadSystemHealth();
                this.loadTasks();
                
                // Auto-refresh every 30 seconds
                setInterval(() => {
                    if (!this.creating) {
                        this.loadTasks();
                    }
                }, 30000);
            },
            
            methods: {
                async loadSystemHealth() {
                    try {
                        const response = await axios.get('/health/detailed');
                        const health = response.data;
                        
                        this.systemHealth = {
                            status: health.status,
                            agents: health.components.agents ? {
                                available: health.components.agents.healthy_count || 0,
                                total: health.components.agents.total_count || 0
                            } : null
                        };
                    } catch (error) {
                        console.error('Failed to load system health:', error);
                    }
                },
                
                // Production-ready API call with caching and retry logic
                async makeApiCall(url, options = {}) {
                    const cacheKey = `${url}_${JSON.stringify(options)}`;
                    const now = Date.now();
                    
                    // Check cache first
                    if (this.apiCache.has(cacheKey)) {
                        const cached = this.apiCache.get(cacheKey);
                        if (now - cached.timestamp < this.cacheTimeout) {
                            return cached.data;
                        }
                    }
                    
                    // Retry logic for production resilience
                    for (let attempt = 0; attempt <= this.maxRetries; attempt++) {
                        try {
                            const response = await axios.get(url, options);
                            
                            // Cache successful response
                            this.apiCache.set(cacheKey, {
                                data: response.data,
                                timestamp: now
                            });
                            
                            this.retryCount = 0; // Reset retry count on success
                            return response.data;
                            
                        } catch (error) {
                            if (attempt === this.maxRetries) {
                                // Log error for monitoring
                                console.error(`API call failed after ${this.maxRetries} retries:`, error);
                                throw error;
                            }
                            
                            // Exponential backoff
                            const delay = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                },

                async loadTasks() {
                    // Respect refresh cooldown for production stability
                    const now = Date.now();
                    if (now - this.lastRefresh < this.refreshCooldown) {
                        return;
                    }
                    this.lastRefresh = now;
                    
                    this.loading = true;
                    try {
                        const data = await this.makeApiCall('/api/v1/tasks');
                        this.tasks = data.tasks || [];
                        
                        // Only load agent details for expanded tasks to reduce API calls
                        for (const task of this.tasks) {
                            if (this.expandedTasks.has(task.id) && task.status !== 'queued') {
                                await this.loadTaskAgents(task.id);
                            }
                        }
                    } catch (error) {
                        this.handleApiError(error, 'Failed to load tasks');
                    } finally {
                        this.loading = false;
                    }
                },
                
                async loadTaskAgents(taskId) {
                    if (this.loadingAgents.has(taskId)) return; // Prevent concurrent requests
                    
                    this.loadingAgents.add(taskId);
                    try {
                        const data = await this.makeApiCall(`/api/v1/tasks/${taskId}/agents`);
                        // Vue 3 reactivity - direct assignment works
                        this.taskAgents[taskId] = data;
                    } catch (error) {
                        this.handleApiError(error, 'Failed to load agent details');
                    } finally {
                        this.loadingAgents.delete(taskId);
                    }
                },
                
                // Toggle task expansion with smart agent loading
                toggleTaskExpansion(taskId) {
                    if (this.expandedTasks.has(taskId)) {
                        this.expandedTasks.delete(taskId);
                    } else {
                        this.expandedTasks.add(taskId);
                        
                        // Load agent details and leaderboard when expanding
                        const task = this.tasks.find(t => t.id === taskId);
                        if (task && task.status !== 'queued') {
                            if (!this.taskAgents[taskId]) {
                                this.loadTaskAgents(taskId);
                            }
                            if (!this.taskLeaderboards[taskId]) {
                                this.loadTaskLeaderboard(taskId);
                            }
                        }
                    }
                },
                
                async loadTaskLeaderboard(taskId) {
                    try {
                        const response = await axios.get(`/api/v1/leaderboard/${taskId}`);
                        this.taskLeaderboards[taskId] = response.data.leaderboard;
                    } catch (error) {
                        console.error('Failed to load leaderboard:', error);
                        // Don't show error to user - leaderboard is optional
                    }
                },
                
                // Production error handling
                handleApiError(error, defaultMessage) {
                    if (error.response?.status === 429) {
                        this.error = 'Too many requests. Please wait a moment before refreshing.';
                    } else if (error.response?.status >= 500) {
                        this.error = 'Server error. Retrying automatically...';
                        // Auto-retry after server errors
                        setTimeout(() => {
                            this.error = null;
                            this.loadTasks();
                        }, 5000);
                    } else {
                        this.error = defaultMessage + ': ' + (error.response?.data?.detail || error.message);
                    }
                },
                
                async createTask() {
                    if (!this.newTask.pr_url || this.newTask.agents.length === 0) {
                        this.error = 'Please provide a PR URL and select at least one agent';
                        return;
                    }
                    
                    this.creating = true;
                    this.error = null;
                    
                    try {
                        const response = await axios.post('/api/v1/tasks', {
                            pr_url: this.newTask.pr_url,
                            agents: this.newTask.agents,
                            max_files: parseInt(this.newTask.max_files)
                        });
                        
                        this.success = `Task created successfully: ${response.data.id.substring(0, 8)}...`;
                        
                        // Reset form
                        this.newTask = {
                            pr_url: '',
                            agents: ['iflow'],
                            max_files: 50
                        };
                        
                        // Refresh tasks
                        await this.loadTasks();
                        
                        // Clear success message after 3 seconds
                        setTimeout(() => { this.success = null; }, 3000);
                        
                    } catch (error) {
                        this.error = 'Failed to create task: ' + (error.response?.data?.detail || error.message);
                    } finally {
                        this.creating = false;
                    }
                },
                
                async runTask(taskId) {
                    try {
                        await axios.post(`/api/v1/tasks/${taskId}/run`);
                        this.success = 'Task started successfully!';
                        await this.loadTasks();
                        setTimeout(() => { this.success = null; }, 3000);
                    } catch (error) {
                        this.error = 'Failed to start task: ' + (error.response?.data?.detail || error.message);
                    }
                },
                
                async cancelTask(taskId) {
                    if (!confirm('Are you sure you want to cancel this task?')) return;
                    
                    try {
                        await axios.delete(`/api/v1/tasks/${taskId}`);
                        this.success = 'Task cancelled successfully!';
                        await this.loadTasks();
                        setTimeout(() => { this.success = null; }, 3000);
                    } catch (error) {
                        this.error = 'Failed to cancel task: ' + (error.response?.data?.detail || error.message);
                    }
                },
                
                downloadBundle(taskId) {
                    window.open(`/api/v1/artifacts/${taskId}/bundle`, '_blank');
                },
                
                async viewArtifacts(taskId) {
                    window.open(`/api/v1/artifacts/${taskId}/list`, '_blank');
                },
                
                async refreshTasks() {
                    await this.loadTasks();
                },
                
                formatDate(dateString) {
                    return new Date(dateString).toLocaleString();
                },
                
                // Live logs functionality
                viewLiveLogs(taskId) {
                    const url = `/logs.html?taskId=${taskId}`;
                    window.open(url, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
